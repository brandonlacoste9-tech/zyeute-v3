name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check environment variables
        run: |
          if [ -z "${{ secrets.VITE_SUPABASE_URL }}" ]; then
            echo "‚ö†Ô∏è Warning: VITE_SUPABASE_URL secret not set. Using placeholder."
          fi
          if [ -z "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ]; then
            echo "‚ö†Ô∏è Warning: VITE_SUPABASE_ANON_KEY secret not set. Using placeholder."
          fi

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder-key' }}
        continue-on-error: false

      - name: Check build output
        run: |
          if [ -d "dist" ]; then
            echo "‚úÖ Build successful"
            ls -lah dist/
          else
            echo "‚ùå Build failed - no dist directory"
            exit 1
          fi

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        run: |
          lhci autorun --collect.staticDistDir=./dist
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

  lighthouse-report:
    runs-on: ubuntu-latest
    needs: lighthouse
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Download Lighthouse results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/

      - name: Comment PR with Lighthouse results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              // Find the manifest file
              const manifestPath = path.join('.lighthouseci', 'manifest.json');
              if (!fs.existsSync(manifestPath)) {
                console.log('No Lighthouse manifest found');
                return;
              }

              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              const reportPath = manifest[0].jsonPath;
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              // Extract key metrics
              const metrics = {
                performance: Math.round(report.categories.performance.score * 100),
                accessibility: Math.round(report.categories.accessibility.score * 100),
                bestPractices: Math.round(report.categories['best-practices'].score * 100),
                seo: Math.round(report.categories.seo.score * 100),
                pwa: report.categories.pwa ? Math.round(report.categories.pwa.score * 100) : 'N/A'
              };

              // Create comment body
              const emoji = (score) => score >= 90 ? 'üü¢' : score >= 50 ? 'üü°' : 'üî¥';
              
              const comment = `## üèÜ Lighthouse Performance Report

| Category | Score |
|----------|-------|
| ${emoji(metrics.performance)} Performance | ${metrics.performance}/100 |
| ${emoji(metrics.accessibility)} Accessibility | ${metrics.accessibility}/100 |
| ${emoji(metrics.bestPractices)} Best Practices | ${metrics.bestPractices}/100 |
| ${emoji(metrics.seo)} SEO | ${metrics.seo}/100 |
| ${metrics.pwa !== 'N/A' ? emoji(metrics.pwa) : '‚ö™'} PWA | ${metrics.pwa}${metrics.pwa !== 'N/A' ? '/100' : ''} |

### Key Metrics
- **First Contentful Paint:** ${report.audits['first-contentful-paint'].displayValue}
- **Largest Contentful Paint:** ${report.audits['largest-contentful-paint'].displayValue}
- **Speed Index:** ${report.audits['speed-index'].displayValue}
- **Time to Interactive:** ${report.audits['interactive'].displayValue}
- **Total Blocking Time:** ${report.audits['total-blocking-time'].displayValue}
- **Cumulative Layout Shift:** ${report.audits['cumulative-layout-shift'].displayValue}

### Recommendations
${report.categories.performance.score < 0.9 ? '‚ö†Ô∏è Performance score below 90. Review suggestions below.' : '‚úÖ Performance is good!'}
${report.categories.accessibility.score < 0.9 ? '‚ö†Ô∏è Accessibility score below 90. Review suggestions below.' : '‚úÖ Accessibility is good!'}

_Full report available in artifacts._
`;

              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });

            } catch (error) {
              console.error('Error creating Lighthouse comment:', error);
            }
